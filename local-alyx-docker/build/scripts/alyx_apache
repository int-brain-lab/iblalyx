#!/bin/bash

export alyx_server_start_file=${alyx_server_start_file:-${ALYX_SRC_PATH}/shared/local/alyx_start_server.out}
export ALYX_ENTRY_ARGS=()

parse_entrypoint_args() {
	local ignore_args=(start_server init_db www www_no_load dev)
	local arg
	if [[ $# -gt 0 ]]; then
		for arg in "$@"; do
			if [[ " ${ignore_args[*]} " =~ " ${arg} " ]]; then
				echo "'$arg' is already turned on by default."
			else
				ALYX_ENTRY_ARGS+=("${arg}")
			fi
		done
	fi
	[[ ${#ALYX_ENTRY_ARGS[@]} -lt 1 ]] && ALYX_ENTRY_ARGS+=("-")
}

parse_entrypoint_args "$@"
ALYX_ENTRY_ARGS+=(dev)
ALYX_STARTUP_CMD=www_no_load

[[ -f "${alyx_server_start_file}" ]] && ALYX_STARTUP_CMD="--help"

echo "$0 starting server w/ www_no_load()"
echo "$0 running alyx bash script command with arguments: ${ALYX_ENTRY_ARGS[*]}"

nohup alyx "$ALYX_STARTUP_CMD" 2>&1 | tee -a "${alyx_server_start_file}" &
alyx "${ALYX_ENTRY_ARGS[@]}"
